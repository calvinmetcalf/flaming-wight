/*!
Math.uuid.js (v1.4)
http://www.broofa.com
mailto:robert@broofa.com

Copyright (c) 2010 Robert Kieffer
Dual licensed under the MIT and GPL licenses.
*/
(function(){var CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(len,radix){var chars=CHARS,uuid=[];radix=radix||chars.length;if(len){for(var i=0;i<len;i++){uuid[i]=chars[0|Math.random()*radix]}}else{var r;uuid[8]=uuid[13]=uuid[18]=uuid[23]="-";uuid[14]="4";for(var i=0;i<36;i++){if(!uuid[i]){r=0|Math.random()*16;uuid[i]=chars[(i==19)?(r&3)|8:r]}}}return uuid.join("")};Math.uuidFast=function(){var chars=CHARS,uuid=new Array(36),rnd=0,r;for(var i=0;i<36;i++){if(i==8||i==13||i==18||i==23){uuid[i]="-"}else{if(i==14){uuid[i]="4"}else{if(rnd<=2){rnd=33554432+(Math.random()*16777216)|0}r=rnd&15;rnd=rnd>>4;uuid[i]=chars[(i==19)?(r&3)|8:r]}}}return uuid.join("")};Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)}).toUpperCase()}})();var Crypto={};(function(){Crypto.MD5=function(string){function RotateLeft(lValue,iShiftBits){return(lValue<<iShiftBits)|(lValue>>>(32-iShiftBits))}function AddUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;lX8=(lX&2147483648);lY8=(lY&2147483648);lX4=(lX&1073741824);lY4=(lY&1073741824);lResult=(lX&1073741823)+(lY&1073741823);if(lX4&lY4){return(lResult^2147483648^lX8^lY8)}if(lX4|lY4){if(lResult&1073741824){return(lResult^3221225472^lX8^lY8)}else{return(lResult^1073741824^lX8^lY8)}}else{return(lResult^lX8^lY8)}}function F(x,y,z){return(x&y)|((~x)&z)}function G(x,y,z){return(x&z)|(y&(~z))}function H(x,y,z){return(x^y^z)}function I(x,y,z){return(y^(x|(~z)))}function FF(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function GG(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function HH(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function II(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function ConvertToWordArray(string){var lWordCount;var lMessageLength=string.length;var lNumberOfWords_temp1=lMessageLength+8;var lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1%64))/64;var lNumberOfWords=(lNumberOfWords_temp2+1)*16;var lWordArray=Array(lNumberOfWords-1);var lBytePosition=0;var lByteCount=0;while(lByteCount<lMessageLength){lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=(lWordArray[lWordCount]|(string.charCodeAt(lByteCount)<<lBytePosition));lByteCount++}lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=lWordArray[lWordCount]|(128<<lBytePosition);lWordArray[lNumberOfWords-2]=lMessageLength<<3;lWordArray[lNumberOfWords-1]=lMessageLength>>>29;return lWordArray}function WordToHex(lValue){var WordToHexValue="",WordToHexValue_temp="",lByte,lCount;for(lCount=0;lCount<=3;lCount++){lByte=(lValue>>>(lCount*8))&255;WordToHexValue_temp="0"+lByte.toString(16);WordToHexValue=WordToHexValue+WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2)}return WordToHexValue}var x=Array();var k,AA,BB,CC,DD,a,b,c,d;var S11=7,S12=12,S13=17,S14=22;var S21=5,S22=9,S23=14,S24=20;var S31=4,S32=11,S33=16,S34=23;var S41=6,S42=10,S43=15,S44=21;x=ConvertToWordArray(string);a=1732584193;b=4023233417;c=2562383102;d=271733878;for(k=0;k<x.length;k+=16){AA=a;BB=b;CC=c;DD=d;a=FF(a,b,c,d,x[k+0],S11,3614090360);d=FF(d,a,b,c,x[k+1],S12,3905402710);c=FF(c,d,a,b,x[k+2],S13,606105819);b=FF(b,c,d,a,x[k+3],S14,3250441966);a=FF(a,b,c,d,x[k+4],S11,4118548399);d=FF(d,a,b,c,x[k+5],S12,1200080426);c=FF(c,d,a,b,x[k+6],S13,2821735955);b=FF(b,c,d,a,x[k+7],S14,4249261313);a=FF(a,b,c,d,x[k+8],S11,1770035416);d=FF(d,a,b,c,x[k+9],S12,2336552879);c=FF(c,d,a,b,x[k+10],S13,4294925233);b=FF(b,c,d,a,x[k+11],S14,2304563134);a=FF(a,b,c,d,x[k+12],S11,1804603682);d=FF(d,a,b,c,x[k+13],S12,4254626195);c=FF(c,d,a,b,x[k+14],S13,2792965006);b=FF(b,c,d,a,x[k+15],S14,1236535329);a=GG(a,b,c,d,x[k+1],S21,4129170786);d=GG(d,a,b,c,x[k+6],S22,3225465664);c=GG(c,d,a,b,x[k+11],S23,643717713);b=GG(b,c,d,a,x[k+0],S24,3921069994);a=GG(a,b,c,d,x[k+5],S21,3593408605);d=GG(d,a,b,c,x[k+10],S22,38016083);c=GG(c,d,a,b,x[k+15],S23,3634488961);b=GG(b,c,d,a,x[k+4],S24,3889429448);a=GG(a,b,c,d,x[k+9],S21,568446438);d=GG(d,a,b,c,x[k+14],S22,3275163606);c=GG(c,d,a,b,x[k+3],S23,4107603335);b=GG(b,c,d,a,x[k+8],S24,1163531501);a=GG(a,b,c,d,x[k+13],S21,2850285829);d=GG(d,a,b,c,x[k+2],S22,4243563512);c=GG(c,d,a,b,x[k+7],S23,1735328473);b=GG(b,c,d,a,x[k+12],S24,2368359562);a=HH(a,b,c,d,x[k+5],S31,4294588738);d=HH(d,a,b,c,x[k+8],S32,2272392833);c=HH(c,d,a,b,x[k+11],S33,1839030562);b=HH(b,c,d,a,x[k+14],S34,4259657740);a=HH(a,b,c,d,x[k+1],S31,2763975236);d=HH(d,a,b,c,x[k+4],S32,1272893353);c=HH(c,d,a,b,x[k+7],S33,4139469664);b=HH(b,c,d,a,x[k+10],S34,3200236656);a=HH(a,b,c,d,x[k+13],S31,681279174);d=HH(d,a,b,c,x[k+0],S32,3936430074);c=HH(c,d,a,b,x[k+3],S33,3572445317);b=HH(b,c,d,a,x[k+6],S34,76029189);a=HH(a,b,c,d,x[k+9],S31,3654602809);d=HH(d,a,b,c,x[k+12],S32,3873151461);c=HH(c,d,a,b,x[k+15],S33,530742520);b=HH(b,c,d,a,x[k+2],S34,3299628645);a=II(a,b,c,d,x[k+0],S41,4096336452);d=II(d,a,b,c,x[k+7],S42,1126891415);c=II(c,d,a,b,x[k+14],S43,2878612391);b=II(b,c,d,a,x[k+5],S44,4237533241);a=II(a,b,c,d,x[k+12],S41,1700485571);d=II(d,a,b,c,x[k+3],S42,2399980690);c=II(c,d,a,b,x[k+10],S43,4293915773);b=II(b,c,d,a,x[k+1],S44,2240044497);a=II(a,b,c,d,x[k+8],S41,1873313359);d=II(d,a,b,c,x[k+15],S42,4264355552);c=II(c,d,a,b,x[k+6],S43,2734768916);b=II(b,c,d,a,x[k+13],S44,1309151649);a=II(a,b,c,d,x[k+4],S41,4149444226);d=II(d,a,b,c,x[k+11],S42,3174756917);c=II(c,d,a,b,x[k+2],S43,718787259);b=II(b,c,d,a,x[k+9],S44,3951481745);a=AddUnsigned(a,AA);b=AddUnsigned(b,BB);c=AddUnsigned(c,CC);d=AddUnsigned(d,DD)}var temp=WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);return temp.toLowerCase()}})();(function(){if(!Object.defineProperty||!(function(){try{Object.defineProperty({},"x",{});return true}catch(e){return false}}())){var orig=Object.defineProperty;Object.defineProperty=function(o,prop,desc){if(orig){try{return orig(o,prop,desc)}catch(e){}}if(o!==Object(o)){throw new TypeError("Object.defineProperty called on non-object")}if(Object.prototype.__defineGetter__&&("get" in desc)){Object.prototype.__defineGetter__.call(o,prop,desc.get)}if(Object.prototype.__defineSetter__&&("set" in desc)){Object.prototype.__defineSetter__.call(o,prop,desc.set)}if("value" in desc){o[prop]=desc.value}return o}}}());if(!Object.keys){Object.keys=function(o){if(o!==Object(o)){throw new TypeError("Object.keys called on non-object")}var ret=[],p;for(p in o){if(Object.prototype.hasOwnProperty.call(o,p)){ret.push(p)}}return ret}}if(!Array.prototype.forEach){Array.prototype.forEach=function(fun){if(this===void 0||this===null){throw new TypeError()}var t=Object(this);var len=t.length>>>0;if(typeof fun!=="function"){throw new TypeError()}var thisp=arguments[1],i;for(i=0;i<len;i++){if(i in t){fun.call(thisp,t[i],i,t)}}}}if(!Array.prototype.map){Array.prototype.map=function(fun){if(this===void 0||this===null){throw new TypeError()}var t=Object(this);var len=t.length>>>0;if(typeof fun!=="function"){throw new TypeError()}var res=[];res.length=len;var thisp=arguments[1],i;for(i=0;i<len;i++){if(i in t){res[i]=fun.call(thisp,t[i],i,t)}}return res}}"use strict";var Pouch=function Pouch(name,opts,callback){if(!(this instanceof Pouch)){return new Pouch(name,opts,callback)}if(typeof opts==="function"||typeof opts==="undefined"){callback=opts;opts={}}if(typeof name==="object"){opts=name;name=undefined}var backend=Pouch.parseAdapter(opts.name||name);opts.name=opts.name||backend.name;opts.adapter=opts.adapter||backend.adapter;if(!Pouch.adapters[opts.adapter]){throw"Adapter is missing"}if(!Pouch.adapters[opts.adapter].valid()){throw"Invalid Adapter"}var adapter=Pouch.adapters[opts.adapter](opts,function(err,db){if(err){if(callback){callback(err)}return}for(var plugin in Pouch.plugins){var pluginObj=Pouch.plugins[plugin](db);for(var api in pluginObj){if(!(api in db)){db[api]=pluginObj[api]}}}callback(null,db)});for(var j in adapter){this[j]=adapter[j]}};Pouch.DEBUG=false;Pouch.adapters={};Pouch.plugins={};Pouch.parseAdapter=function(name){var match=name.match(/([a-z\-]*):\/\/(.*)/);if(match){name=/http(s?)/.test(match[1])?match[1]+"://"+match[2]:match[2];var adapter=match[1];if(!Pouch.adapters[adapter].valid()){throw"Invalid adapter"}return{name:name,adapter:match[1]}}var rank={idb:1,leveldb:2,websql:3,http:4,https:4};var rankedAdapter=Object.keys(Pouch.adapters).sort(function(a,b){return rank[a]-rank[b]})[0];return{name:name,adapter:rankedAdapter};throw"No Valid Adapter."};Pouch.destroy=function(name,callback){for(var plugin in Pouch.plugins){Pouch.plugins[plugin]._delete(name)}var opts=Pouch.parseAdapter(name);Pouch.adapters[opts.adapter].destroy(opts.name,callback)};Pouch.adapter=function(id,obj){if(obj.valid()){Pouch.adapters[id]=obj}};Pouch.plugin=function(id,obj){Pouch.plugins[id]=obj};Pouch.Errors={MISSING_BULK_DOCS:{status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"},MISSING_DOC:{status:404,error:"not_found",reason:"missing"},REV_CONFLICT:{status:409,error:"conflict",reason:"Document update conflict"},INVALID_ID:{status:400,error:"invalid_id",reason:"_id field must contain a string"},MISSING_ID:{status:412,error:"missing_id",reason:"_id is required for puts"},RESERVED_ID:{status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."},NOT_OPEN:{status:412,error:"precondition_failed",reason:"Database not open so cannot close"},UNKNOWN_ERROR:{status:500,error:"unknown_error",reason:"Database encountered an unknown error"}};if(typeof module!=="undefined"&&module.exports){global.Pouch=Pouch;Pouch.merge=require("./pouch.merge.js").merge;Pouch.collate=require("./pouch.collate.js").collate;Pouch.replicate=require("./pouch.replicate.js").replicate;Pouch.utils=require("./pouch.utils.js");module.exports=Pouch;var adapters=["leveldb","http"];adapters.map(function(adapter){var adapter_path="./adapters/pouch."+adapter+".js";require(adapter_path)});require("./plugins/pouchdb.mapreduce.js")}else{this.Pouch=Pouch}(function(){if(typeof module!=="undefined"&&module.exports){module.exports=Pouch}Pouch.collate=function(a,b){var ai=collationIndex(a);var bi=collationIndex(b);if((ai-bi)!==0){return ai-bi}if(a===null){return 0}if(typeof a==="number"){return a-b}if(typeof a==="boolean"){return a<b?-1:1}if(typeof a==="string"){return stringCollate(a,b)}if(Array.isArray(a)){return arrayCollate(a,b)}if(typeof a==="object"){return objectCollate(a,b)}};var stringCollate=function(a,b){return(a===b)?0:((a>b)?1:-1)};var objectCollate=function(a,b){var ak=Object.keys(a),bk=Object.keys(b);var len=Math.min(ak.length,bk.length);for(var i=0;i<len;i++){var sort=Pouch.collate(ak[i],bk[i]);if(sort!==0){return sort}sort=Pouch.collate(a[ak[i]],b[bk[i]]);if(sort!==0){return sort}}return(ak.length===bk.length)?0:(ak.length>bk.length)?1:-1};var arrayCollate=function(a,b){var len=Math.min(a.length,b.length);for(var i=0;i<len;i++){var sort=Pouch.collate(a[i],b[i]);if(sort!==0){return sort}}return(a.length===b.length)?0:(a.length>b.length)?1:-1};var collationIndex=function(x){var id=["boolean","number","string","object"];if(id.indexOf(typeof x)!==-1){if(x===null){return 1}return id.indexOf(typeof x)+2}if(Array.isArray(x)){return 4.5}}}).call(this);(function(){if(typeof module!=="undefined"&&module.exports){module.exports=Pouch;var utils=require("./pouch.utils.js");for(var k in utils){global[k]=utils[k]}}function pathToTree(path){var root=[path.shift(),[]];var leaf=root;while(path.length){nleaf=[path.shift(),[]];leaf[1].push(nleaf);leaf=nleaf}return root}function stem(tree,depth){var stemmedPaths=rootToLeaf(tree).map(function(path){var stemmed=path.ids.slice(-depth);return{pos:path.pos+(path.ids.length-stemmed.length),ids:pathToTree(stemmed)}});return stemmedPaths.reduce(function(prev,current,i,arr){return doMerge(prev,current,true).tree},[stemmedPaths.shift()])}function mergeTree(in_tree1,in_tree2){var queue=[{tree1:in_tree1,tree2:in_tree2}];var conflicts=false;while(queue.length>0){var item=queue.pop();var tree1=item.tree1;var tree2=item.tree2;for(var i=0;i<tree2[1].length;i++){if(!tree1[1][0]){conflicts="new_leaf";tree1[1][0]=tree2[1][i];continue}var merged=false;for(var j=0;j<tree1[1].length;j++){if(tree1[1][j][0]==tree2[1][i][0]){queue.push({tree1:tree1[1][j],tree2:tree2[1][i]});merged=true}}if(!merged){conflicts="new_branch";tree1[1].push(tree2[1][i]);tree1[1].sort()}}}return{conflicts:conflicts,tree:in_tree1}}function doMerge(tree,path,dontExpand){var restree=[];var conflicts=false;var merged=false;var res,branch;if(!tree.length){return{tree:[path],conflicts:"new_leaf"}}tree.forEach(function(branch){if(branch.pos===path.pos&&branch.ids[0]===path.ids[0]){res=mergeTree(branch.ids,path.ids);restree.push({pos:branch.pos,ids:res.tree});conflicts=conflicts||res.conflicts;merged=true}else{if(dontExpand!==true){var t1=branch.pos<path.pos?branch:path;var t2=branch.pos<path.pos?path:branch;var diff=t2.pos-t1.pos;var candidateParents=[];var trees=[];trees.push({ids:t1.ids,diff:diff,parent:null,parentIdx:null});while(trees.length>0){var item=trees.pop();if(item.diff==0){if(item.ids[0]==t2.ids[0]){candidateParents.push(item)}continue}if(!item.ids){continue}item.ids[1].forEach(function(el,idx){trees.push({ids:el,diff:item.diff-1,parent:item.ids,parentIdx:idx})})}var el=candidateParents[0];if(!el){restree.push(branch)}else{res=mergeTree(el.ids,t2.ids);el.parent[1][el.parentIdx]=res.tree;restree.push({pos:t1.pos,ids:t1.ids});conflicts=conflicts||res.conflicts;merged=true}}else{restree.push(branch)}}});if(!merged){restree.push(path)}restree.sort(function(a,b){return a.pos-b.pos});return{tree:restree,conflicts:conflicts||"internal_node"}}Pouch.merge=function(tree,path,depth){tree=extend(true,[],tree);path=extend(true,{},path);var newTree=doMerge(tree,path);return{tree:stem(newTree.tree,depth),conflicts:newTree.conflicts}}}).call(this);if(typeof module!=="undefined"&&module.exports){module.exports=Pouch}(function(){function replicate(src,target,opts,callback,replicateRet){fetchCheckpoint(src,target,opts,function(checkpoint){var results=[];var completed=false;var pending=0;var last_seq=checkpoint;var continuous=opts.continuous||false;var result={ok:true,start_time:new Date(),docs_read:0,docs_written:0};function isCompleted(){if(completed&&pending===0){result.end_time=new Date();writeCheckpoint(src,target,opts,last_seq,function(){call(callback,null,result)})}}if(replicateRet.cancelled){return}var repOpts={continuous:continuous,since:checkpoint,style:"all_docs",onChange:function(change){last_seq=change.seq;results.push(change);result.docs_read++;pending++;var diff={};diff[change.id]=change.changes.map(function(x){return x.rev});target.revsDiff(diff,function(err,diffs){if(err){if(continuous){replicateRet.cancel()}call(callback,err,null);return}if(Object.keys(diffs).length===0){pending--;isCompleted();return}for(var id in diffs){diffs[id].missing.map(function(rev){src.get(id,{revs:true,rev:rev,attachments:true},function(err,doc){target.bulkDocs({docs:[doc]},{new_edits:false},function(){if(opts.onChange){opts.onChange.apply(this,[result])}result.docs_written++;pending--;isCompleted()})})})}})},complete:function(err,res){completed=true;isCompleted()}};if(opts.filter){repOpts.filter=opts.filter}if(opts.query_params){repOpts.query_params=opts.query_params}var changes=src.changes(repOpts);if(opts.continuous){replicateRet.cancel=changes.cancel}})}function toPouch(db,callback){if(typeof db==="string"){return new Pouch(db,callback)}callback(null,db)}Pouch.replicate=function(src,target,opts,callback){if(opts instanceof Function){callback=opts;opts={}}if(opts===undefined){opts={}}var ret=function(){this.cancelled=false;this.cancel=function(){this.cancelled=true}};var replicateRet=new ret();toPouch(src,function(err,src){if(err){return call(callback,err)}toPouch(target,function(err,target){if(err){return call(callback,err)}replicate(src,target,opts,callback,replicateRet)})});return replicateRet}}).call(this);var call=function(fun){var args=Array.prototype.slice.call(arguments,1);if(typeof fun===typeof Function){fun.apply(this,args)}};var yankError=function(callback){return function(err,results){if(err||results[0].error){call(callback,err||results[0])}else{call(callback,null,results[0])}}};var isAttachmentId=function(id){return(/\//.test(id)&&!/^_local/.test(id)&&!/^_design/.test(id))};var parseDocId=function(id){var ids=(typeof id==="string")&&!(/^_(design|local)\//.test(id))?id.split("/"):[id];return{docId:ids[0],attachmentId:ids.splice(1).join("/").replace(/^\/+/,"")}};var isDeleted=function(metadata,rev){if(!metadata||!metadata.deletions){return false}if(!rev){rev=winningRev(metadata)}if(rev.indexOf("-")>=0){rev=rev.split("-")[1]}return metadata.deletions[rev]===true};var isValidId=function(id){if(/^_/.test(id)){return/^_(design|local)/.test(id)}return true};var parseDoc=function(doc,newEdits){var error=null;if(doc._id){var id=parseDocId(doc._id);if(id.attachmentId!==""){var attachment=btoa(JSON.stringify(doc));doc={_id:id.docId,};if(!doc._attachments){doc._attachments={}}doc._attachments[id.attachmentId]={content_type:"application/json",data:attachment}}}if(newEdits){if(!doc._id){doc._id=Math.uuid()}var newRevId=Math.uuid(32,16).toLowerCase();var nRevNum;if(doc._rev){var revInfo=/^(\d+)-(.+)$/.exec(doc._rev);if(!revInfo){throw"invalid value for property '_rev'"}doc._rev_tree=[{pos:parseInt(revInfo[1],10),ids:[revInfo[2],[[newRevId,[]]]]}];nRevNum=parseInt(revInfo[1],10)+1}else{doc._rev_tree=[{pos:1,ids:[newRevId,[]]}];nRevNum=1}}else{if(doc._revisions){doc._rev_tree=[{pos:doc._revisions.start-doc._revisions.ids.length+1,ids:doc._revisions.ids.reduce(function(acc,x){if(acc===null){return[x,[]]}else{return[x,[acc]]}},null)}];nRevNum=doc._revisions.start;newRevId=doc._revisions.ids[0]}if(!doc._rev_tree){var revInfo=/^(\d+)-(.+)$/.exec(doc._rev);nRevNum=parseInt(revInfo[1],10);newRevId=revInfo[2];doc._rev_tree=[{pos:parseInt(revInfo[1],10),ids:[revInfo[2],[]]}]}}if(typeof doc._id!=="string"){error=Pouch.Errors.INVALID_ID}else{if(!isValidId(doc._id)){error=Pouch.Errors.RESERVED_ID}}doc._id=decodeURIComponent(doc._id);doc._rev=[nRevNum,newRevId].join("-");if(error){return error}return Object.keys(doc).reduce(function(acc,key){if(/^_/.test(key)&&key!=="_attachments"){acc.metadata[key.slice(1)]=doc[key]}else{acc.data[key]=doc[key]}return acc},{metadata:{},data:{}})};var compareRevs=function(a,b){if(a.id!==b.id){return(a.id<b.id?-1:1)}if(a.deleted^b.deleted){return(a.deleted?-1:1)}if(a.rev_tree[0].pos===b.rev_tree[0].pos){return(a.rev_tree[0].ids<b.rev_tree[0].ids?-1:1)}return(a.rev_tree[0].start<b.rev_tree[0].start?-1:1)};var traverseRevTree=function(revs,callback){var toVisit=[];revs.forEach(function(tree){toVisit.push({pos:tree.pos,ids:tree.ids})});while(toVisit.length>0){var node=toVisit.pop(),pos=node.pos,tree=node.ids;var newCtx=callback(tree[1].length==0,pos,tree[0],node.ctx);tree[1].forEach(function(branch){toVisit.push({pos:pos+1,ids:branch,ctx:newCtx})})}};var collectRevs=function(path){var revs=[];traverseRevTree([path],function(isLeaf,pos,id){revs.push({rev:pos+"-"+id,status:"available"})});return revs};var collectLeaves=function(revs){var leaves=[];traverseRevTree(revs,function(isLeaf,pos,id){if(isLeaf){leaves.unshift({rev:pos+"-"+id,pos:pos})}});leaves.sort(function(a,b){return b.pos-a.pos});leaves.map(function(leaf){delete leaf.pos});return leaves};var collectConflicts=function(revs){var leaves=collectLeaves(revs);leaves.shift();return leaves.map(function(x){return x.rev})};var fetchCheckpoint=function(src,target,opts,callback){var filter_func="";if(typeof opts.filter!="undefined"){filter_func=opts.filter.toString()}var id=Crypto.MD5(src.id()+target.id()+filter_func);src.get("_local/"+id,function(err,doc){if(err&&err.status===404){callback(0)}else{callback(doc.last_seq)}})};var writeCheckpoint=function(src,target,opts,checkpoint,callback){var filter_func="";if(typeof opts.filter!="undefined"){filter_func=opts.filter.toString()}var check={_id:"_local/"+Crypto.MD5(src.id()+target.id()+filter_func),last_seq:checkpoint};src.get(check._id,function(err,doc){if(doc&&doc._rev){check._rev=doc._rev}src.put(check,function(err,doc){callback()})})};var winningRev=function(metadata){var deletions=metadata.deletions||{};var leafs=[];traverseRevTree(metadata.rev_tree,function(isLeaf,pos,id){if(isLeaf){leafs.push({pos:pos,id:id})}});leafs.forEach(function(leaf){leaf.deleted=leaf.id in deletions});leafs.sort(function(a,b){if(a.deleted!==b.deleted){return a.deleted>b.deleted?1:-1}if(a.pos!==b.pos){return b.pos-a.pos}return a.id<b.id?1:-1});return leafs[0].pos+"-"+leafs[0].id};var rootToLeaf=function(tree){var paths=[];traverseRevTree(tree,function(isLeaf,pos,id,history){history=history?history.slice(0):[];history.push(id);if(isLeaf){var rootPos=pos+1-history.length;paths.unshift({pos:rootPos,ids:history})}return history});return paths};var arrayFirst=function(arr,callback){for(var i=0;i<arr.length;i++){if(callback(arr[i],i)===true){return arr[i]}}return false};var filterChange=function(opts){return function(change){if(opts.filter&&!opts.filter.call(this,change.doc)){return}if(!opts.include_docs){delete change.doc}call(opts.onChange,change)}};var ajax=function ajax(options,callback){if(options.success&&callback===undefined){callback=options.success}var success=function sucess(obj,_,xhr){if(options.dataType===false&&typeof obj!=="string"){obj=JSON.stringify(obj)}call(callback,null,obj,xhr)};var error=function error(err){if(err){var errObj=err.responseText?{status:err.status}:err;try{errObj=$.extend({},errObj,JSON.parse(err.responseText))}catch(e){}call(callback,errObj)}else{call(callback,true)}};var defaults={success:success,error:error,headers:{Accept:"application/json","Content-Type":"application/json",},dataType:"json",timeout:10000};options=$.extend({},defaults,options);if(options.data&&typeof options.data!=="string"){options.data=JSON.stringify(options.data)}if(options.auth){options.beforeSend=function(xhr){var token=btoa(options.auth.username+":"+options.auth.password);xhr.setRequestHeader("Authorization","Basic "+token)}}if($.ajax){return $.ajax(options)}else{if(options.data){options.body=options.data;delete options.data}if(options.type){options.method=options.type;delete options.type}if(options.auth){var token=btoa(options.auth.username+":"+options.auth.password);options.headers.Authorization="Basic "+token}return request(options,function(err,response,body){if(err){err.status=response?response.statusCode:400;return call(options.error,err)}var content_type=response.headers["content-type"],data=(body||"");if(options.dataType&&(/json/.test(content_type)||(/^[\s]*{/.test(data)&&/}[\s]*$/.test(data)))){data=JSON.parse(data)}if(data.error){data.status=response.statusCode;call(options.error,data)}else{call(options.success,data,"OK",response)}})}};var class2type={};var types=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"];for(var i=0;i<types.length;i++){var typename=types[i];class2type["[object "+typename+"]"]=typename.toLowerCase()}var core_toString=class2type.toString;var core_hasOwn=class2type.hasOwnProperty;var type=function(obj){if(obj===null){return String(obj)}return typeof obj==="object"||typeof obj==="function"?class2type[core_toString.call(obj)]||"object":typeof obj};var isPlainObject=function(obj){if(!obj||type(obj)!=="object"||obj.nodeType||isWindow(obj)){return false}try{if(obj.constructor&&!core_hasOwn.call(obj,"constructor")&&!core_hasOwn.call(obj.constructor.prototype,"isPrototypeOf")){return false}}catch(e){return false}var key;for(key in obj){}return key===undefined||core_hasOwn.call(obj,key)};var isFunction=function(obj){return type(obj)==="function"};var isWindow=function(obj){return obj!=null&&obj==obj.window};var isArray=Array.isArray||function(obj){return type(obj)==="array"};var extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&!isFunction(target)){target={}}if(length===i){target=this;--i}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&isArray(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}target[name]=extend(deep,clone,copy)}else{if(copy!==undefined){target[name]=copy}}}}}return target};var win=this;var localJSON=(function(){if(!win.localStorage){return false}return{set:function(prop,val){localStorage.setItem(prop,JSON.stringify(val))},get:function(prop,def){try{if(localStorage.getItem(prop)===null){return def}return JSON.parse((localStorage.getItem(prop)||"false"))}catch(err){return def}},remove:function(prop){localStorage.removeItem(prop)}}})();if(typeof btoa==="undefined"){btoa=function(str){return new Buffer(unescape(encodeURIComponent(str)),"binary").toString("base64")}}if(typeof atob==="undefined"){atob=function(str){return decodeURIComponent(escape(new Buffer(str,"base64").toString("binary")))}}if(typeof module!=="undefined"&&module.exports){var crypto=require("crypto");var Crypto={MD5:function(str){return crypto.createHash("md5").update(str).digest("hex")}};request=require("request");_=require("underscore");$=_;module.exports={Crypto:Crypto,call:call,yankError:yankError,isAttachmentId:isAttachmentId,parseDocId:parseDocId,parseDoc:parseDoc,isDeleted:isDeleted,compareRevs:compareRevs,collectRevs:collectRevs,collectLeaves:collectLeaves,collectConflicts:collectConflicts,fetchCheckpoint:fetchCheckpoint,writeCheckpoint:writeCheckpoint,winningRev:winningRev,rootToLeaf:rootToLeaf,arrayFirst:arrayFirst,filterChange:filterChange,ajax:ajax,atob:atob,btoa:btoa,extend:extend}}"use strict";var HTTP_TIMEOUT=10000;function parseUri(str){var o=parseUri.options;var m=o.parser[o.strictMode?"strict":"loose"].exec(str);var uri={};var i=14;while(i--){uri[o.key[i]]=m[i]||""}uri[o.q.name]={};uri[o.key[12]].replace(o.q.parser,function($0,$1,$2){if($1){uri[o.q.name][$1]=$2}});return uri}parseUri.options={strictMode:false,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};function getHost(name){if(/http(s?):/.test(name)){var uri=parseUri(name);uri.remote=true;if(uri.user||uri.password){uri.auth={username:uri.user,password:uri.password}}var parts=uri.path.replace(/(^\/|\/$)/g,"").split("/");uri.db=parts.pop();uri.path=parts.join("/");return uri}return{host:"",path:"/",db:name,auth:false}}function genDBUrl(opts,path){if(opts.remote){var pathDel=!opts.path?"":"/";return opts.protocol+"://"+opts.host+":"+opts.port+"/"+opts.path+pathDel+opts.db+"/"+path}return"/"+opts.db+"/"+path}function genUrl(opts,path){if(opts.remote){return opts.protocol+"://"+opts.host+":"+opts.port+"/"+path}return"/"+path}var HttpPouch=function(opts,callback){var host=getHost(opts.name);if(opts.auth){host.auth=opts.auth}var db_url=genDBUrl(host,"");var api={};var uuids={list:[],get:function(opts,callback){if(typeof opts==="function"){callback=opts;opts={count:10}}var cb=function(err,body){if(err||!("uuids" in body)){call(callback,err||Pouch.Errors.UNKNOWN_ERROR)}else{uuids.list=uuids.list.concat(body.uuids);call(callback,null,"OK")}};var params="?count="+opts.count;ajax({auth:host.auth,type:"GET",url:genUrl(host,"_uuids")+params},cb)}};var createDB=function(){ajax({auth:host.auth,type:"PUT",url:db_url},function(err,ret){if(err&&err.status===401){ajax({auth:host.auth,type:"HEAD",url:db_url},function(err,ret){if(err){call(callback,err)}else{call(callback,null,api)}})}else{if(!err||err.status===412){call(callback,null,api)}else{call(callback,Pouch.Errors.UNKNOWN_ERROR)}}})};ajax({auth:host.auth,type:"GET",url:db_url},function(err,ret){if(err){if(err.status===404){createDB()}else{call(callback,err)}}else{call(callback,null,api)}});api.type=function(){return"http"};api.id=function(){return genDBUrl(host,"")};api.request=function(options,callback){options.auth=host.auth;options.url=genDBUrl(host,options.url);ajax(options,callback)};api.compact=function(callback){ajax({auth:host.auth,url:genDBUrl(host,"_compact"),type:"POST"},callback)};api.info=function(callback){ajax({auth:host.auth,type:"GET",url:genDBUrl(host,""),},callback)};api.get=function(id,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}var params=[];if(opts.revs){params.push("revs=true")}if(opts.revs_info){params.push("revs_info=true")}if(opts.attachments){params.push("attachments=true")}if(opts.rev){params.push("rev="+opts.rev)}if(opts.conflicts){params.push("conflicts="+opts.conflicts)}params=params.join("&");params=params===""?"":"?"+params;var options={auth:host.auth,type:"GET",url:genDBUrl(host,id+params)};var parts=id.split("/");if((parts.length>1&&parts[0]!=="_design"&&parts[0]!=="_local")||(parts.length>2&&parts[0]==="_design"&&parts[0]!=="_local")){options.dataType=false}ajax(options,function(err,doc,xhr){if(err){return call(callback,Pouch.Errors.MISSING_DOC)}call(callback,null,doc,xhr)})};api.remove=function(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}ajax({auth:host.auth,type:"DELETE",url:genDBUrl(host,doc._id)+"?rev="+doc._rev},callback)};api.removeAttachment=function idb_removeAttachment(id,rev,callback){ajax({auth:host.auth,type:"DELETE",url:genDBUrl(host,id)+"?rev="+rev,},callback)};api.putAttachment=function(id,rev,doc,type,callback){ajax({auth:host.auth,type:"PUT",url:genDBUrl(host,id)+"?rev="+rev,headers:{"Content-Type":type},data:doc},callback)};api.put=function(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(!doc||!("_id" in doc)){return call(callback,Pouch.Errors.MISSING_ID)}var params=[];if(opts&&typeof opts.new_edits!=="undefined"){params.push("new_edits="+opts.new_edits)}params=params.join("&");if(params!==""){params="?"+params}ajax({auth:host.auth,type:"PUT",url:genDBUrl(host,doc._id)+params,data:doc},callback)};api.post=function(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(!("_id" in doc)){if(uuids.list.length>0){doc._id=uuids.list.pop();api.put(doc,opts,callback)}else{uuids.get(function(err,resp){if(err){return call(callback,Pouch.Errors.UNKNOWN_ERROR)}doc._id=uuids.list.pop();api.put(doc,opts,callback)})}}else{api.put(doc,opts,callback)}};api.bulkDocs=function(req,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(!opts){opts={}}if(typeof opts.new_edits!=="undefined"){req.new_edits=opts.new_edits}ajax({auth:host.auth,type:"POST",url:genDBUrl(host,"_bulk_docs"),data:req},callback)};api.allDocs=function(opts,callback){if(typeof opts==="function"){callback=opts;opts={}}var params=[];if(opts.conflicts){params.push("conflicts=true")}if(opts.include_docs){params.push("include_docs=true")}if(opts.startkey){params.push("startkey="+encodeURIComponent(JSON.stringify(opts.startkey)))}if(opts.endkey){params.push("endkey="+encodeURIComponent(JSON.stringify(opts.endkey)))}if(opts.keys){params.push("keys="+encodeURIComponent(JSON.stringify(opts.keys)))}params=params.join("&");if(params!==""){params="?"+params}ajax({auth:host.auth,type:"GET",url:genDBUrl(host,"_all_docs"+params)},callback)};api.changes=function(opts){if(Pouch.DEBUG){console.log(db_url+": Start Changes Feed: continuous="+opts.continuous)}var params=[],paramsStr;if(opts.style){params.push("style="+opts.style)}if(opts.include_docs||opts.filter&&typeof opts.filter==="function"){params.push("include_docs=true")}if(opts.continuous){params.push("feed=longpoll")}if(opts.conflicts){params.push("conflicts=true")}if(opts.descending){params.push("descending=true")}if(opts.filter&&typeof opts.filter==="string"){params.push("filter="+opts.filter)}if(opts.query_params&&typeof opts.query_params==="object"){for(var param_name in opts.query_params){if(opts.query_params.hasOwnProperty(param_name)){params.push(param_name+"="+opts.query_params[param_name])}}}paramsStr="?";if(params.length>0){paramsStr+=params.join("&")}var xhr;var last_seq;var fetch=function(since,callback){var xhrOpts={auth:host.auth,type:"GET",url:genDBUrl(host,"_changes"+paramsStr+"&since="+since),timeout:null};last_seq=since;if(opts.aborted){return}xhr=ajax(xhrOpts,callback)};var fetchTimeout=10;var fetchRetryCount=0;var fetched=function(err,res){if(res&&res.results){res.results.forEach(function(c){var hasFilter=opts.filter&&typeof opts.filter==="function";if(opts.aborted||hasFilter&&!opts.filter.apply(this,[c.doc])){return}call(opts.onChange,c)})}if(res&&res.last_seq){last_seq=res.last_seq}if(opts.continuous){if(err){fetchRetryCount+=1}else{fetchRetryCount=0}var timeoutMultiplier=1<<fetchRetryCount;var retryWait=fetchTimeout*timeoutMultiplier;var maximumWait=opts.maximumWait||30000;if(retryWait>maximumWait){call(opts.complete,err||Pouch.Errors.UNKNOWN_ERROR,null)}setTimeout(function(){fetch(last_seq,fetched)},retryWait)}else{call(opts.complete,null,res)}};fetch(opts.since||0,fetched);return{cancel:function(){if(Pouch.DEBUG){console.log(db_url+": Cancel Changes Feed")}opts.aborted=true;xhr.abort()}}};api.revsDiff=function(req,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}ajax({auth:host.auth,type:"POST",url:genDBUrl(host,"_revs_diff"),data:req},function(err,res){call(callback,null,res)})};api.replicate={};api.replicate.from=function(url,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return Pouch.replicate(url,api,opts,callback)};api.replicate.to=function(dbName,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return Pouch.replicate(api,dbName,opts,callback)};api.close=function(callback){call(callback,null)};return api};HttpPouch.destroy=function(name,callback){var host=getHost(name);ajax({auth:host.auth,type:"DELETE",url:genDBUrl(host,"")},callback)};HttpPouch.valid=function(){return true};if(typeof module!=="undefined"&&module.exports){var pouchdir="../";this.Pouch=require(pouchdir+"pouch.js");this.ajax=Pouch.utils.ajax}Pouch.adapter("http",HttpPouch);Pouch.adapter("https",HttpPouch);window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||{READ_WRITE:"readwrite"};window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange;window.storageInfo=window.storageInfo||window.webkitStorageInfo;window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;var idbError=function(callback){return function(event){call(callback,{status:500,error:event.type,reason:event.target})}};var IdbPouch=function(opts,callback){var POUCH_VERSION=1;var DOC_STORE="document-store";var BY_SEQ_STORE="by-sequence";var ATTACH_STORE="attach-store";var META_STORE="meta-store";var name=opts.name;var req=indexedDB.open(name,POUCH_VERSION);var meta={id:"meta-store",updateSeq:0,};var instanceId=null;var storeAttachmentsInIDB=true;var api={};var idb=null;if(Pouch.DEBUG){console.log(name+": Open Database")}req.onupgradeneeded=function(e){var db=e.target.result;db.createObjectStore(DOC_STORE,{keyPath:"id"}).createIndex("seq","seq",{unique:true});db.createObjectStore(BY_SEQ_STORE,{autoIncrement:true}).createIndex("_rev","_rev",{unique:true});db.createObjectStore(ATTACH_STORE,{keyPath:"digest"});db.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:false})};req.onsuccess=function(e){idb=e.target.result;var txn=idb.transaction([META_STORE],IDBTransaction.READ_WRITE);idb.onversionchange=function(){idb.close()};if(idb.setVersion&&Number(idb.version)!==POUCH_VERSION){var versionReq=idb.setVersion(POUCH_VERSION);versionReq.onsuccess=function(evt){function setVersionComplete(){req.onsuccess(e)}evt.target.result.oncomplete=setVersionComplete;req.onupgradeneeded(e)};return}var req=txn.objectStore(META_STORE).get("meta-store");req.onsuccess=function(e){var reqDBId,result;if(e.target.result){meta=e.target.result}if(name+"_id" in meta){instanceId=meta[name+"_id"]}else{instanceId=Math.uuid();meta[name+"_id"]=instanceId;reqDBId=txn.objectStore(META_STORE).put(meta)}call(callback,null,api)}};req.onerror=idbError(callback);api.type=function(){return"idb"};api.id=function idb_id(){return instanceId};api.bulkDocs=function idb_bulkDocs(req,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(!opts){opts={}}if(!req.docs){return call(callback,Pouch.Errors.MISSING_BULK_DOCS)}var newEdits="new_edits" in opts?opts.new_edits:true;var userDocs=extend(true,[],req.docs);var docInfos=userDocs.map(function(doc,i){var newDoc=parseDoc(doc,newEdits);newDoc._bulk_seq=i;if(doc._deleted){if(!newDoc.metadata.deletions){newDoc.metadata.deletions={}}newDoc.metadata.deletions[doc._rev.split("-")[1]]=true}return newDoc});var results=[];var docs=[];docInfos.forEach(function(docInfo){if(docInfo.error){return results.push(docInfo)}if(!docs.length||docInfo.metadata.id!==docs[0].metadata.id){return docs.unshift(docInfo)}results.push(makeErr(Pouch.Errors.REV_CONFLICT,docInfo._bulk_seq))});function processDocs(){if(!docs.length){return}var currentDoc=docs.shift();var req=txn.objectStore(DOC_STORE).get(currentDoc.metadata.id);req.onsuccess=function process_docRead(event){var oldDoc=event.target.result;if(!oldDoc){insertDoc(currentDoc)}else{updateDoc(oldDoc,currentDoc)}}}function complete(event){var aresults=[];results.sort(sortByBulkSeq);results.forEach(function(result){delete result._bulk_seq;if(result.error){aresults.push(result);return}var metadata=result.metadata;var rev=winningRev(metadata);aresults.push({ok:true,id:metadata.id,rev:rev});if(/_local/.test(metadata.id)){return}var change={id:metadata.id,seq:metadata.seq,changes:collectLeaves(metadata.rev_tree),doc:result.data};change.doc._rev=rev;IdbPouch.Changes.emitChange(name,change)});call(callback,null,aresults)}function writeDoc(docInfo,callback){var err=null;var recv=0;docInfo.data._id=docInfo.metadata.id;docInfo.data._rev=docInfo.metadata.rev;meta.updateSeq++;var req=txn.objectStore(META_STORE).put(meta);if(isDeleted(docInfo.metadata,docInfo.metadata.rev)){docInfo.data._deleted=true}var attachments=docInfo.data._attachments?Object.keys(docInfo.data._attachments):[];for(var key in docInfo.data._attachments){if(!docInfo.data._attachments[key].stub){var data=docInfo.data._attachments[key].data;var digest="md5-"+Crypto.MD5(data);delete docInfo.data._attachments[key].data;docInfo.data._attachments[key].digest=digest;saveAttachment(docInfo,digest,data,function(err){recv++;collectResults(err)})}else{recv++;collectResults()}}if(!attachments.length){finish()}function collectResults(attachmentErr){if(!err){if(attachmentErr){err=attachmentErr;call(callback,err)}else{if(recv==attachments.length){finish()}}}}function finish(){var dataReq=txn.objectStore(BY_SEQ_STORE).put(docInfo.data);dataReq.onsuccess=function(e){if(Pouch.DEBUG){console.log(name+": Wrote Document ",docInfo.metadata.id)}docInfo.metadata.seq=e.target.result;delete docInfo.metadata.rev;var metaDataReq=txn.objectStore(DOC_STORE).put(docInfo.metadata);metaDataReq.onsuccess=function(){results.push(docInfo);call(callback)}}}}function updateDoc(oldDoc,docInfo){var merged=Pouch.merge(oldDoc.rev_tree,docInfo.metadata.rev_tree[0],1000);var inConflict=(isDeleted(oldDoc)&&isDeleted(docInfo.metadata))||(!isDeleted(oldDoc)&&newEdits&&merged.conflicts!=="new_leaf");if(inConflict){results.push(makeErr(Pouch.Errors.REV_CONFLICT,docInfo._bulk_seq));return processDocs()}docInfo.metadata.rev_tree=merged.tree;writeDoc(docInfo,processDocs)}function insertDoc(docInfo){if("was_delete" in opts&&isDeleted(docInfo.metadata)){results.push(Pouch.Errors.MISSING_DOC);return processDocs()}writeDoc(docInfo,processDocs)}function makeErr(err,seq){err._bulk_seq=seq;return err}function saveAttachment(docInfo,digest,data,callback){if(storeAttachmentsInIDB){var objectStore=txn.objectStore(ATTACH_STORE);var getReq=objectStore.get(digest).onsuccess=function(e){var ref=[docInfo.metadata.id,docInfo.metadata.rev].join("@");var newAtt={digest:digest,body:data};if(e.target.result){if(e.target.result.refs){newAtt.refs=e.target.result.refs;newAtt.refs[ref]=true}}else{newAtt.refs={};newAtt.refs[ref]=true}var putReq=objectStore.put(newAtt).onsuccess=function(e){call(callback)};putReq.onerror=putReq.ontimeout=idbError(callback)};getReq.onerror=getReq.ontimeout=idbError(callback)}else{writeAttachmentToFile(digest,data);call(callback)}}var txn=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,META_STORE],IDBTransaction.READ_WRITE);txn.onerror=idbError(callback);txn.ontimeout=idbError(callback);txn.oncomplete=complete;processDocs()};function sortByBulkSeq(a,b){return a._bulk_seq-b._bulk_seq}api.get=function idb_get(id,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}id=parseDocId(id);if(id.attachmentId!==""){return api.getAttachment(id,{decode:true},callback)}var result;var txn=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");txn.oncomplete=function(){if("error" in result){call(callback,result)}else{call(callback,null,result)}};txn.objectStore(DOC_STORE).get(id.docId).onsuccess=function(e){var metadata=e.target.result;if(!e.target.result||(isDeleted(metadata,opts.rev)&&!opts.rev)){result=Pouch.Errors.MISSING_DOC;return}var rev=winningRev(metadata);var key=opts.rev?opts.rev:rev;var index=txn.objectStore(BY_SEQ_STORE).index("_rev");index.get(key).onsuccess=function(e){var doc=e.target.result;if(opts.revs){var path=arrayFirst(rootToLeaf(metadata.rev_tree),function(arr){return arr.ids.indexOf(doc._rev.split("-")[1])!==-1});path.ids.reverse();doc._revisions={start:(path.pos+path.ids.length)-1,ids:path.ids}}if(opts.revs_info){doc._revs_info=metadata.rev_tree.reduce(function(prev,current){return prev.concat(collectRevs(current))},[])}if(opts.conflicts){var conflicts=collectConflicts(metadata.rev_tree);if(conflicts.length){doc._conflicts=conflicts}}if(opts.attachments&&doc._attachments){var attachments=Object.keys(doc._attachments);var recv=0;attachments.forEach(function(key){api.getAttachment(doc._id+"/"+key,{txn:txn},function(err,data){doc._attachments[key].data=data;if(++recv===attachments.length){result=doc}})})}else{if(doc._attachments){for(var key in doc._attachments){doc._attachments[key].stub=true}}result=doc}}}};api.getAttachment=function(id,opts,callback){if(opts instanceof Function){callback=opts;opts={}}if(typeof id==="string"){id=parseDocId(id)}var result;var txn;if("txn" in opts){txn=opts.txn}else{txn=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");txn.oncomplete=function(){call(callback,null,result)}}txn.objectStore(DOC_STORE).get(id.docId).onsuccess=function(e){var metadata=e.target.result;var bySeq=txn.objectStore(BY_SEQ_STORE);bySeq.get(metadata.seq).onsuccess=function(e){var attachment=e.target.result._attachments[id.attachmentId];var digest=attachment.digest;var type=attachment.content_type;function postProcessDoc(data){if(opts.decode){data=atob(data)}return data}if(storeAttachmentsInIDB){txn.objectStore(ATTACH_STORE).get(digest).onsuccess=function(e){var data=e.target.result.body;result=postProcessDoc(data);if("txn" in opts){call(callback,null,result)}}}else{readAttachmentFromFile(digest,function(data){result=postProcessDoc(data);if("txn" in opts){call(callback,null,result)}})}}};return};api.put=function(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(!doc||!("_id" in doc)){return call(callback,Pouch.Errors.MISSING_ID)}return api.bulkDocs({docs:[doc]},opts,yankError(callback))};api.post=function idb_put(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return api.bulkDocs({docs:[doc]},opts,yankError(callback))};api.putAttachment=function idb_putAttachment(id,rev,doc,type,callback){id=parseDocId(id);api.get(id.docId,{attachments:true},function(err,obj){obj._attachments||(obj._attachments={});obj._attachments[id.attachmentId]={content_type:type,data:btoa(doc)};api.put(obj,callback)})};api.remove=function idb_remove(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}opts.was_delete=true;var newDoc=extend(true,{},doc);newDoc._deleted=true;return api.bulkDocs({docs:[newDoc]},opts,yankError(callback))};api.removeAttachment=function idb_removeAttachment(id,rev,callback){id=parseDocId(id);api.get(id.docId,function(err,obj){if(err){call(callback,err);return}if(obj._rev!=rev){call(callback,Pouch.Errors.REV_CONFLICT);return}obj._attachments||(obj._attachments={});delete obj._attachments[id.attachmentId];api.put(obj,callback)})};api.allDocs=function idb_allDocs(opts,callback){if(typeof opts==="function"){callback=opts;opts={}}var start="startkey" in opts?opts.startkey:false;var end="endkey" in opts?opts.endkey:false;var descending="descending" in opts?opts.descending:false;descending=descending?"prev":null;var keyRange=start&&end?IDBKeyRange.bound(start,end,false,false):start?IDBKeyRange.lowerBound(start,true):end?IDBKeyRange.upperBound(end):null;var result;var transaction=idb.transaction([DOC_STORE,BY_SEQ_STORE],"readonly");transaction.oncomplete=function(){callback(null,result)};var oStore=transaction.objectStore(DOC_STORE);var oCursor=descending?oStore.openCursor(keyRange,descending):oStore.openCursor(keyRange);var results=[];oCursor.onsuccess=function(e){if(!e.target.result){result={total_rows:results.length,rows:results};return}var cursor=e.target.result;function allDocsInner(metadata,data){if(/_local/.test(metadata.id)){return cursor["continue"]()}if(!isDeleted(metadata)){var doc={id:metadata.id,key:metadata.id,value:{rev:winningRev(metadata)}};if(opts.include_docs){doc.doc=data;doc.doc._rev=winningRev(metadata);if(opts.conflicts){doc.doc._conflicts=collectConflicts(metadata.rev_tree)}}results.push(doc)}cursor["continue"]()}if(!opts.include_docs){allDocsInner(cursor.value)}else{var index=transaction.objectStore(BY_SEQ_STORE);index.get(cursor.value.seq).onsuccess=function(event){allDocsInner(cursor.value,event.target.result)}}}};api.info=function idb_info(callback){var count=0;var result;var txn=idb.transaction([DOC_STORE],"readonly");txn.oncomplete=function(){callback(null,result)};txn.objectStore(DOC_STORE).openCursor().onsuccess=function(e){var cursor=e.target.result;if(!cursor){result={db_name:name,doc_count:count,update_seq:meta.updateSeq};return}if(cursor.value.deleted!==true){count++}cursor["continue"]()}};api.revsDiff=function idb_revsDiff(req,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}var ids=Object.keys(req);var count=0;var missing={};function readDoc(err,doc,id){req[id].map(function(revId){var matches=function(x){return x.rev!==revId};if(!doc||doc._revs_info.every(matches)){if(!missing[id]){missing[id]={missing:[]}}missing[id].missing.push(revId)}});if(++count===ids.length){return call(callback,null,missing)}}ids.map(function(id){api.get(id,{revs_info:true},function(err,doc){readDoc(err,doc,id)})})};api.changes=function idb_changes(opts){if(!opts.seq){opts.seq=0}if(opts.since){opts.seq=opts.since}if(Pouch.DEBUG){console.log(name+": Start Changes Feed: continuous="+opts.continuous)}var descending="descending" in opts?opts.descending:false;descending=descending?"prev":null;var results=[],resultIndices={},dedupResults=[];var id=name+":"+Math.uuid();var txn;if(opts.filter&&typeof opts.filter==="string"){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter;fetchChanges()})}else{fetchChanges()}function fetchChanges(){txn=idb.transaction([DOC_STORE,BY_SEQ_STORE]);txn.oncomplete=onTxnComplete;var req=descending?txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.seq,true),descending):txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.seq,true));req.onsuccess=onsuccess;req.onerror=onerror}function onsuccess(event){if(!event.target.result){if(opts.continuous&&!opts.cancelled){IdbPouch.Changes.addListener(name,id,opts)}for(var i=0,l=results.length;i<l;i++){var result=results[i];if(result){dedupResults.push(result)}}return false}var cursor=event.target.result;var changeId=cursor.value._id,changeIdIndex=resultIndices[changeId];if(changeIdIndex!==undefined){results[changeIdIndex].seq=cursor.key;results.push(results[changeIdIndex]);results[changeIdIndex]=null;resultIndices[changeId]=results.length-1;return cursor["continue"]()}var index=txn.objectStore(DOC_STORE);index.get(cursor.value._id).onsuccess=function(event){var metadata=event.target.result;if(/_local/.test(metadata.id)){return cursor["continue"]()}var mainRev=winningRev(metadata);var index=txn.objectStore(BY_SEQ_STORE).index("_rev");index.get(mainRev).onsuccess=function(docevent){var doc=docevent.target.result;var changeList=[{rev:mainRev}];if(opts.style==="all_docs"){changeList=collectLeaves(metadata.rev_tree)}var change={id:metadata.id,seq:cursor.key,changes:changeList,doc:doc,};if(isDeleted(metadata,mainRev)){change.deleted=true}if(opts.conflicts){change.doc._conflicts=collectConflicts(metadata.rev_tree)}var changeId=change.id,changeIdIndex=resultIndices[changeId];if(changeIdIndex!==undefined){results[changeIdIndex]=null}results.push(change);resultIndices[changeId]=results.length-1;cursor["continue"]()}}}function onTxnComplete(){dedupResults.map(function(c){if(opts.filter&&!opts.filter.apply(this,[c.doc])){return}if(!opts.include_docs){delete c.doc}call(opts.onChange,c)});if(!opts.continuous||(opts.continuous&&!opts.cancelled)){call(opts.complete,null,{results:dedupResults})}}function onerror(error){if(opts.continuous&&!opts.cancelled){IdbPouch.Changes.addListener(name,id,opts)}else{call(opts.complete)}}if(opts.continuous){return{cancel:function(){if(Pouch.DEBUG){console.log(name+": Cancel Changes Feed")}opts.cancelled=true;IdbPouch.Changes.removeListener(name,id)}}}};api.replicate={};api.replicate.from=function idb_replicate_from(url,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return Pouch.replicate(url,api,opts,callback)};api.replicate.to=function idb_replicate_to(dbName,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return Pouch.replicate(api,dbName,opts,callback)};function toArray(list){return Array.prototype.slice.call(list||[],0)}function fileErrorHandler(e){console.error("File system error",e)}function deleteOrphanedFiles(currentQuota){api.allDocs({include_docs:true},function(err,response){window.requestFileSystem(window.PERSISTENT,currentQuota,function(fs){var dirReader=fs.root.createReader();var entries=[];var docRows=response.rows;var readEntries=function(){dirReader.readEntries(function(results){if(!results.length){for(var i in entries){var entryIsReferenced=false;for(var k in docRows){if(docRows[k].doc){var aDoc=docRows[k].doc;if(aDoc._attachments){for(var j in aDoc._attachments){if(aDoc._attachments[j].digest==entries[i].name){entryIsReferenced=true}}}if(entryIsReferenced){break}}}if(!entryIsReferenced){entries[i].remove(function(){if(Pouch.DEBUG){console.log("Removed orphaned attachment: "+entries[i].name)}},fileErrorHandler)}}}else{entries=entries.concat(toArray(results));readEntries()}},fileErrorHandler)};readEntries()},fileErrorHandler)})}function writeAttachmentToFile(digest,data,type){window.storageInfo.queryUsageAndQuota(window.PERSISTENT,function(currentUsage,currentQuota){var newQuota=currentQuota;if(currentQuota==0){newQuota=1000*1024*1024}else{if((currentUsage/currentQuota)>0.8){deleteOrphanedFiles(currentQuota)}else{if((currentUsage/currentQuota)>0.9){newQuota=2*currentQuota}}}if(Pouch.DEBUG){console.log("Current file quota: "+currentQuota+", current usage:"+currentUsage+", new quota will be: "+newQuota)}window.storageInfo.requestQuota(window.PERSISTENT,newQuota,function(grantedBytes){window.storageInfo.queryUsageAndQuota(window.PERSISTENT,function(currentUsage,currentQuota){window.requestFileSystem(window.PERSISTENT,currentQuota,function(fs){fs.root.getFile(digest,{create:true},function(fileEntry){fileEntry.createWriter(function(fileWriter){fileWriter.onwriteend=function(e){if(Pouch.DEBUG){console.log("Wrote attachment")}};fileWriter.onerror=function(e){console.error("File write failed: "+e.toString())};var blob=new Blob([data],{type:type});fileWriter.write(blob)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)}function readAttachmentFromFile(digest,callback){window.storageInfo.queryUsageAndQuota(window.PERSISTENT,function(currentUsage,currentQuota){window.requestFileSystem(window.PERSISTENT,currentQuota,function(fs){fs.root.getFile(digest,{},function(fileEntry){fileEntry.file(function(file){var reader=new FileReader();reader.onloadend=function(e){data=this.result;if(Pouch.DEBUG){console.log("Read attachment")}callback(data)};reader.readAsBinaryString(file)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)}api.close=function(callback){if(idb===null){return call(callback,Pouch.Errors.NOT_OPEN)}idb.close();call(callback,null)};return api};IdbPouch.valid=function idb_valid(){if(!document.location.host){console.error("indexedDB cannot be used in pages served from the filesystem")}return !!window.indexedDB&&!!document.location.host};IdbPouch.destroy=function idb_destroy(name,callback){if(Pouch.DEBUG){console.log(name+": Delete Database")}IdbPouch.Changes.clearListeners(name);var req=indexedDB.deleteDatabase(name);req.onsuccess=function(){call(callback,null)};req.onerror=idbError(callback)};IdbPouch.Changes=(function(){var api={};var listeners={};api.addListener=function(db,id,opts){if(!listeners[db]){listeners[db]={}}listeners[db][id]=opts};api.removeListener=function(db,id){delete listeners[db][id]};api.clearListeners=function(db){delete listeners[db]};api.emitChange=function(db,change){if(!listeners[db]){return}for(var i in listeners[db]){var opts=listeners[db][i];if(opts.filter&&!opts.filter.apply(this,[change.doc])){return}if(!opts.include_docs){delete change.doc}opts.onChange.apply(opts.onChange,[change])}};return api})();Pouch.adapter("idb",IdbPouch);"use strict";function quote(str){return"'"+str+"'"}var POUCH_VERSION=1;var POUCH_SIZE=5*1024*1024;var DOC_STORE=quote("document-store");var BY_SEQ_STORE=quote("by-sequence");var ATTACH_STORE=quote("attach-store");var META_STORE=quote("metadata-store");var unknownError=function(callback){return function(event){call(callback,{status:500,error:event.type,reason:event.target})}};var webSqlPouch=function(opts,callback){var api={};var update_seq=0;var name=opts.name;var db=openDatabase(name,POUCH_VERSION,name,POUCH_SIZE);if(!db){return call(callback,Pouch.Errors.UNKNOWN_ERROR)}function dbCreated(){callback(null,api)}db.transaction(function(tx){var meta="CREATE TABLE IF NOT EXISTS "+META_STORE+" (update_seq)";var attach="CREATE TABLE IF NOT EXISTS "+ATTACH_STORE+" (digest, json)";var doc="CREATE TABLE IF NOT EXISTS "+DOC_STORE+" (id unique, seq, json, winningseq)";var seq="CREATE TABLE IF NOT EXISTS "+BY_SEQ_STORE+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, rev UNIQUE, json)";tx.executeSql(attach);tx.executeSql(doc);tx.executeSql(seq);tx.executeSql(meta);var sql="SELECT update_seq FROM "+META_STORE;tx.executeSql(sql,[],function(tx,result){if(!result.rows.length){var initSeq="INSERT INTO "+META_STORE+" (update_seq) VALUES (?)";tx.executeSql(initSeq,[0]);return}update_seq=result.rows.item(0).update_seq})},unknownError(callback),dbCreated);api.type=function(){return"websql"};api.id=function(){var id=localJSON.get(name+"_id",null);if(id===null){id=Math.uuid();localJSON.set(name+"_id",id)}return id};api.info=function(callback){db.transaction(function(tx){var sql="SELECT COUNT(id) AS count FROM "+DOC_STORE;tx.executeSql(sql,[],function(tx,result){callback(null,{db_name:name,doc_count:result.rows.item(0).count,update_seq:update_seq})})})};api.bulkDocs=function idb_bulkDocs(req,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(!opts){opts={}}if(!req.docs){return call(callback,Pouch.Errors.MISSING_BULK_DOCS)}var newEdits="new_edits" in opts?opts.new_edits:true;var userDocs=extend(true,[],req.docs);var docInfos=userDocs.map(function(doc,i){var newDoc=parseDoc(doc,newEdits);newDoc._bulk_seq=i;if(doc._deleted){if(!newDoc.metadata.deletions){newDoc.metadata.deletions={}}newDoc.metadata.deletions[doc._rev.split("-")[1]]=true}return newDoc});var tx;var results=[];var docs=[];var fetchedDocs={};docInfos.forEach(function(docInfo){if(docInfo.error){return results.push(docInfo)}if(!docs.length||docInfo.metadata.id!==docs[0].metadata.id){return docs.unshift(docInfo)}results.push(makeErr(Pouch.Errors.REV_CONFLICT,docInfo._bulk_seq))});function sortByBulkSeq(a,b){return a._bulk_seq-b._bulk_seq}function complete(event){var aresults=[];results.sort(sortByBulkSeq);results.forEach(function(result){delete result._bulk_seq;if(result.error){aresults.push(result);return}var metadata=result.metadata;var rev=winningRev(metadata);aresults.push({ok:true,id:metadata.id,rev:rev});if(/_local/.test(metadata.id)){return}var change={id:metadata.id,seq:metadata.seq,changes:collectLeaves(metadata.rev_tree),doc:result.data};change.doc._rev=rev;update_seq++;var sql="UPDATE "+META_STORE+" SET update_seq=?";tx.executeSql(sql,[update_seq],function(){webSqlPouch.Changes.emitChange(name,change)})});call(callback,null,aresults)}function writeDoc(docInfo,callback,isUpdate){var err=null;var recv=0;docInfo.data._id=docInfo.metadata.id;docInfo.data._rev=docInfo.metadata.rev;if(isDeleted(docInfo.metadata,docInfo.metadata.rev)){docInfo.data._deleted=true}var attachments=docInfo.data._attachments?Object.keys(docInfo.data._attachments):[];for(var key in docInfo.data._attachments){if(!docInfo.data._attachments[key].stub){var data=docInfo.data._attachments[key].data;var digest="md5-"+Crypto.MD5(data);delete docInfo.data._attachments[key].data;docInfo.data._attachments[key].digest=digest;saveAttachment(docInfo,digest,data,function(err){recv++;collectResults(err)})}else{recv++;collectResults()}}if(!attachments.length){finish()}function collectResults(attachmentErr){if(!err){if(attachmentErr){err=attachmentErr;call(callback,err)}else{if(recv==attachments.length){finish()}}}}function dataWritten(tx,result){var seq=docInfo.metadata.seq=result.insertId;delete docInfo.metadata.rev;var mainRev=winningRev(docInfo.metadata);var sql=isUpdate?"UPDATE "+DOC_STORE+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+BY_SEQ_STORE+" WHERE rev=?) WHERE id=?":"INSERT INTO "+DOC_STORE+" (id, seq, winningseq, json) VALUES (?, ?, ?, ?);";var params=isUpdate?[seq,JSON.stringify(docInfo.metadata),mainRev,docInfo.metadata.id]:[docInfo.metadata.id,seq,seq,JSON.stringify(docInfo.metadata)];tx.executeSql(sql,params,function(tx,result){results.push(docInfo);call(callback,null)})}function finish(){var data=docInfo.data;var sql="INSERT INTO "+BY_SEQ_STORE+" (rev, json) VALUES (?, ?);";tx.executeSql(sql,[data._rev,JSON.stringify(data)],dataWritten)}}function updateDoc(oldDoc,docInfo){var merged=Pouch.merge(oldDoc.rev_tree,docInfo.metadata.rev_tree[0],1000);var inConflict=(isDeleted(oldDoc)&&isDeleted(docInfo.metadata))||(!isDeleted(oldDoc)&&newEdits&&merged.conflicts!=="new_leaf");if(inConflict){results.push(makeErr(Pouch.Errors.REV_CONFLICT,docInfo._bulk_seq));return processDocs()}docInfo.metadata.rev_tree=merged.tree;writeDoc(docInfo,processDocs,true)}function insertDoc(docInfo){if("was_delete" in opts&&isDeleted(docInfo.metadata)){results.push(Pouch.Errors.MISSING_DOC);return processDocs()}writeDoc(docInfo,processDocs,false)}function processDocs(){if(!docs.length){return complete()}var currentDoc=docs.shift();var id=currentDoc.metadata.id;if(id in fetchedDocs){updateDoc(fetchedDocs[id],currentDoc)}else{insertDoc(currentDoc)}}function makeErr(err,seq){err._bulk_seq=seq;return err}function saveAttachment(docInfo,digest,data,callback){var ref=[docInfo.metadata.id,docInfo.metadata.rev].join("@");var newAtt={digest:digest,body:data};var sql="SELECT * FROM "+ATTACH_STORE+" WHERE digest=?";tx.executeSql(sql,[digest],function(tx,result){if(!result.rows.length){newAtt.refs={};newAtt.refs[ref]=true;sql="INSERT INTO "+ATTACH_STORE+"(digest, json) VALUES (?, ?)";tx.executeSql(sql,[digest,JSON.stringify(newAtt)],function(){call(callback,null)})}else{newAtt.refs=JSON.parse(result.rows.item(0).json).refs;sql="UPDATE "+ATTACH_STORE+" SET json=? WHERE digest=?";tx.executeSql(sql,[JSON.stringify(newAtt),digest],function(){call(callback,null)})}})}function metadataFetched(tx,results){for(var j=0;j<results.rows.length;j++){var row=results.rows.item(j);fetchedDocs[row.id]=JSON.parse(row.json)}processDocs()}db.transaction(function(txn){tx=txn;var ids="("+docs.map(function(d){return quote(d.metadata.id)}).join(",")+")";var sql="SELECT * FROM "+DOC_STORE+" WHERE id IN "+ids;tx.executeSql(sql,[],metadataFetched)},unknownError(callback))};api.put=function(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(!doc||!("_id" in doc)){return call(callback,Pouch.Errors.MISSING_ID)}return api.bulkDocs({docs:[doc]},opts,yankError(callback))};api.post=function idb_put(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return api.bulkDocs({docs:[doc]},opts,yankError(callback))};api.revsDiff=function idb_revsDiff(req,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}var ids=Object.keys(req);var count=0;var missing={};function readDoc(err,doc,id){req[id].map(function(revId){var matches=function(x){return x.rev!==revId};if(!doc||doc._revs_info.every(matches)){if(!missing[id]){missing[id]={missing:[]}}missing[id].missing.push(revId)}});if(++count===ids.length){return call(callback,null,missing)}}ids.map(function(id){api.get(id,{revs_info:true},function(err,doc){readDoc(err,doc,id)})})};api.remove=function idb_remove(doc,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}opts.was_delete=true;var newDoc=extend(true,{},doc);newDoc._deleted=true;return api.bulkDocs({docs:[newDoc]},opts,yankError(callback))};api.get=function(id,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}id=parseDocId(id);if(id.attachmentId!==""){return api.getAttachment(id,{decode:true},callback)}var result;db.transaction(function(tx){var sql="SELECT * FROM "+DOC_STORE+" WHERE id=?";tx.executeSql(sql,[id.docId],function(tx,results){if(!results.rows.length){result=Pouch.Errors.MISSING_DOC;return}var metadata=JSON.parse(results.rows.item(0).json);if(isDeleted(metadata,opts.rev)&&!opts.rev){result=Pouch.Errors.MISSING_DOC;return}var rev=winningRev(metadata);var key=opts.rev?opts.rev:rev;var sql="SELECT * FROM "+BY_SEQ_STORE+" WHERE rev=?";tx.executeSql(sql,[key],function(tx,results){var doc=JSON.parse(results.rows.item(0).json);if(opts.revs){var path=arrayFirst(rootToLeaf(metadata.rev_tree),function(arr){return arr.ids.indexOf(doc._rev.split("-")[1])!==-1});path.ids.reverse();doc._revisions={start:(path.pos+path.ids.length)-1,ids:path.ids}}if(opts.revs_info){doc._revs_info=metadata.rev_tree.reduce(function(prev,current){return prev.concat(collectRevs(current))},[])}if(opts.conflicts){var conflicts=collectConflicts(metadata.rev_tree);if(conflicts.length){doc._conflicts=conflicts}}if(opts.attachments&&doc._attachments){var attachments=Object.keys(doc._attachments);var recv=0;attachments.forEach(function(key){api.getAttachment(doc._id+"/"+key,{txn:tx},function(err,data){doc._attachments[key].data=data;if(++recv===attachments.length){result=doc}})})}else{if(doc._attachments){for(var key in doc._attachments){doc._attachments[key].stub=true}}result=doc}})})},unknownError(callback),function(){if("error" in result){call(callback,result)}else{call(callback,null,result)}})};api.allDocs=function(opts,callback){if(typeof opts==="function"){callback=opts;opts={}}var results=[];var start="startkey" in opts?opts.startkey:false;var end="endkey" in opts?opts.endkey:false;var descending="descending" in opts?opts.descending:false;var sql="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq";if(start){sql+=" WHERE "+DOC_STORE+'.id >= "'+start+'"'}if(end){sql+=(start?" AND ":" WHERE ")+DOC_STORE+'.id <= "'+end+'"'}sql+=" ORDER BY "+DOC_STORE+".id "+(descending?"DESC":"ASC");db.transaction(function(tx){tx.executeSql(sql,[],function(tx,result){for(var i=0,l=result.rows.length;i<l;i++){var doc=result.rows.item(i);var metadata=JSON.parse(doc.metadata);var data=JSON.parse(doc.data);if(!(/_local/.test(metadata.id)||isDeleted(metadata))){var doc={id:metadata.id,key:metadata.id,value:{rev:winningRev(metadata)}};if(opts.include_docs){doc.doc=data;doc.doc._rev=winningRev(metadata);if(opts.conflicts){doc.doc._conflicts=collectConflicts(metadata.rev_tree)}}results.push(doc)}}})},unknownError(callback),function(){call(callback,null,{total_rows:results.length,rows:results})})};api.changes=function idb_changes(opts){if(!opts.seq){opts.seq=0}if(opts.since){opts.seq=opts.since}if(Pouch.DEBUG){console.log(name+": Start Changes Feed: continuous="+opts.continuous)}var descending="descending" in opts?opts.descending:false;descending=descending?"prev":null;var results=[],resultIndices={},dedupResults=[];var id=name+":"+Math.uuid();var txn;if(opts.filter&&typeof opts.filter==="string"){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter;fetchChanges()})}else{fetchChanges()}function fetchChanges(){var sql="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq WHERE "+DOC_STORE+".seq > "+opts.seq+" ORDER BY "+DOC_STORE+".seq "+(descending?"DESC":"ASC");db.transaction(function(tx){tx.executeSql(sql,[],function(tx,result){for(var i=0,l=result.rows.length;i<l;i++){var doc=result.rows.item(i);var metadata=JSON.parse(doc.metadata);if(!/_local/.test(metadata.id)){var change={id:metadata.id,seq:doc.seq,changes:collectLeaves(metadata.rev_tree),doc:JSON.parse(doc.data),};change.doc._rev=winningRev(metadata);if(isDeleted(metadata,change.doc._rev)){change.deleted=true}if(opts.conflicts){change.doc._conflicts=collectConflicts(metadata.rev_tree)}results.push(change)}}for(var i=0,l=results.length;i<l;i++){var result=results[i];if(result){dedupResults.push(result)}}dedupResults.map(function(c){if(opts.filter&&!opts.filter.apply(this,[c.doc])){return}if(!opts.include_docs){delete c.doc}call(opts.onChange,c)});if(opts.continuous&&!opts.cancelled){webSqlPouch.Changes.addListener(name,id,opts)}else{call(opts.complete,null,{results:dedupResults})}})})}if(opts.continuous){return{cancel:function(){if(Pouch.DEBUG){console.log(name+": Cancel Changes Feed")}opts.cancelled=true;webSqlPouch.Changes.removeListener(name,id)}}}};api.getAttachment=function(id,opts,callback){if(opts instanceof Function){callback=opts;opts={}}if(typeof id==="string"){id=parseDocId(id)}var res;if("txn" in opts){fetchAttachment(opts.txn)}else{db.transaction(fetchAttachment,unknownError(callback),function(){call(callback,null,res)})}function postProcessDoc(data){if(opts.decode){return atob(data)}return data}function fetchAttachment(tx){var sql="SELECT "+BY_SEQ_STORE+".json AS data FROM "+DOC_STORE+" JOIN "+BY_SEQ_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".seq WHERE "+DOC_STORE+'.id = "'+id.docId+'"';tx.executeSql(sql,[],function(tx,result){var doc=JSON.parse(result.rows.item(0).data);var attachment=doc._attachments[id.attachmentId];var digest=attachment.digest;var type=attachment.content_type;var sql="SELECT * FROM "+ATTACH_STORE+" WHERE digest=?";tx.executeSql(sql,[digest],function(tx,result){var data=JSON.parse(result.rows.item(0).json).body;res=postProcessDoc(data);if("txn" in opts){call(callback,null,res)}})})}};api.putAttachment=function idb_putAttachment(id,rev,doc,type,callback){id=parseDocId(id);api.get(id.docId,{attachments:true},function(err,obj){obj._attachments||(obj._attachments={});obj._attachments[id.attachmentId]={content_type:type,data:btoa(doc)};api.put(obj,callback)})};api.removeAttachment=function idb_removeAttachment(id,rev,callback){id=parseDocId(id);api.get(id.docId,function(err,obj){if(err){call(callback,err);return}if(obj._rev!=rev){call(callback,Pouch.Errors.REV_CONFLICT);return}obj._attachments||(obj._attachments={});delete obj._attachments[id.attachmentId];api.put(obj,callback)})};api.replicate={};api.replicate.from=function idb_replicate_from(url,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return Pouch.replicate(url,api,opts,callback)};api.replicate.to=function idb_replicate_to(dbName,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return Pouch.replicate(api,dbName,opts,callback)}};webSqlPouch.valid=function(){return !!window.openDatabase};webSqlPouch.destroy=function(name,callback){var db=openDatabase(name,POUCH_VERSION,name,POUCH_SIZE);localJSON.set(name+"_id",null);db.transaction(function(tx){tx.executeSql("DROP TABLE IF EXISTS "+DOC_STORE,[]);tx.executeSql("DROP TABLE IF EXISTS "+BY_SEQ_STORE,[]);tx.executeSql("DROP TABLE IF EXISTS "+ATTACH_STORE,[]);tx.executeSql("DROP TABLE IF EXISTS "+META_STORE,[])},unknownError(callback),function(){call(callback,null)})};webSqlPouch.Changes=(function(){var api={};var listeners={};api.addListener=function(db,id,opts){if(!listeners[db]){listeners[db]={}}listeners[db][id]=opts};api.removeListener=function(db,id){delete listeners[db][id]};api.clearListeners=function(db){delete listeners[db]};api.emitChange=function(db,change){if(!listeners[db]){return}for(var i in listeners[db]){var opts=listeners[db][i];if(opts.filter&&!opts.filter.apply(this,[change.doc])){return}if(!opts.include_docs){delete change.doc}opts.onChange.apply(opts.onChange,[change])}};return api})();Pouch.adapter("websql",webSqlPouch);"use strict";var MapReduce=function(db){function viewQuery(fun,options){if(!options.complete){return}function sum(values){return values.reduce(function(a,b){return a+b},0)}var results=[];var current=null;var num_started=0;var completed=false;var emit=function(key,val){var viewRow={id:current._id,key:key,value:val};if(options.startkey&&Pouch.collate(key,options.startkey)<0){return}if(options.endkey&&Pouch.collate(key,options.endkey)>0){return}if(options.key&&Pouch.collate(key,options.key)!==0){return}num_started++;if(options.include_docs){if(val&&typeof val==="object"&&val._id){db.get(val._id,function(_,joined_doc){if(joined_doc){viewRow.doc=joined_doc}results.push(viewRow);checkComplete()});return}else{viewRow.doc=current.doc}}results.push(viewRow)};eval("fun.map = "+fun.map.toString()+";");if(fun.reduce){eval("fun.reduce = "+fun.reduce.toString()+";")}var conflicts=("conflicts" in options?options.conflicts:false);var checkComplete=function(){if(completed&&results.length==num_started){results.sort(function(a,b){return Pouch.collate(a.key,b.key)});if(options.descending){results.reverse()}if(options.reduce===false){return options.complete(null,{rows:results})}var groups=[];results.forEach(function(e){var last=groups[groups.length-1]||null;if(last&&Pouch.collate(last.key[0][0],e.key)===0){last.key.push([e.key,e.id]);last.value.push(e.value);return}groups.push({key:[[e.key,e.id]],value:[e.value]})});groups.forEach(function(e){e.value=fun.reduce(e.key,e.value)||null;e.key=e.key[0][0]});options.complete(null,{rows:groups})}};db.changes({conflicts:conflicts,include_docs:true,onChange:function(doc){if(!("deleted" in doc)){current={doc:doc.doc};fun.map.call(this,doc.doc)}},complete:function(){completed=true;checkComplete()}})}function httpQuery(fun,opts,callback){var params=[];if(typeof opts.reduce!=="undefined"){params.push("reduce="+opts.reduce)}if(typeof opts.include_docs!=="undefined"){params.push("include_docs="+opts.include_docs)}if(typeof opts.limit!=="undefined"){params.push("limit="+opts.limit)}if(typeof opts.descending!=="undefined"){params.push("descending="+opts.descending)}if(typeof opts.startkey!=="undefined"){params.push("startkey="+encodeURIComponent(JSON.stringify(opts.startkey)))}if(typeof opts.endkey!=="undefined"){params.push("endkey="+encodeURIComponent(JSON.stringify(opts.endkey)))}if(typeof opts.key!=="undefined"){params.push("key="+encodeURIComponent(JSON.stringify(opts.key)))}params=params.join("&");params=params===""?"":"?"+params;if(typeof fun==="string"){var parts=fun.split("/");db.request({type:"GET",url:"_design/"+parts[0]+"/_view/"+parts[1]+params},callback);return}var queryObject=JSON.stringify(fun,function(key,val){if(typeof val==="function"){return val+""}return val});db.request({type:"POST",url:"_temp_view"+params,data:queryObject},callback)}function query(fun,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}if(callback){opts.complete=callback}if(db.type()==="http"){return httpQuery(fun,opts,callback)}if(typeof fun==="object"){return viewQuery(fun,opts)}var parts=fun.split("/");db.get("_design/"+parts[0],function(err,doc){if(err){if(callback){callback(err)}return}viewQuery({map:doc.views[parts[1]].map,reduce:doc.views[parts[1]].reduce},opts)})}return{query:query}};MapReduce._delete=function(){};Pouch.plugin("mapreduce",MapReduce);